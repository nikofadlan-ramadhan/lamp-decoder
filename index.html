<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ICODE Lamp Frame Decoder</title>
<style>
body {
    font-family: monospace;
    background:#111;
    color:#0f0;
    padding:20px;
}
textarea {
    width:100%;
    height:120px;
    background:#000;
    color:#0f0;
}
table {
    border-collapse: collapse;
    width:100%;
    margin-top:20px;
}
th, td {
    border:1px solid #0f0;
    padding:6px;
}
th { background:#003300; }
button { padding:8px 16px; margin-top:10px; }
.ok { color:#00ff00; }
.err { color:#ff4444; }

footer {
    margin-top:40px;
    text-align:center;
    color:#00aa00;
    opacity:0.8;
}
</style>
</head>
<body>

<h2>ICODE Lamp Frame Decoder (UTC+7)</h2>

<textarea id="hexInput" placeholder="Paste HEX frame here..."></textarea>
<br>
<button onclick="parse()">Decode</button>

<table id="result">
<tr>
<th>Field</th>
<th>Hex</th>
<th>Value</th>
</tr>
</table>

<footer>
— Decoder Tool Okin —
</footer>

<script>

let dateOverflow = false;

function hexToInt(hex){
    return parseInt(hex,16);
}

function hexToSigned32(hex){
    let val = parseInt(hex,16);
    if (val > 0x7FFFFFFF) val -= 0x100000000;
    return val;
}

function formatTimeUTC7(hex){

    let ss = parseInt(hex.slice(0,2),16);
    let mm = parseInt(hex.slice(2,4),16);
    let hh = parseInt(hex.slice(4,6),16);

    hh += 7; // UTC +7

    if(hh >= 24){
        hh -= 24;
        dateOverflow = true;
    } else {
        dateOverflow = false;
    }

    return `${hh.toString().padStart(2,'0')}:` +
           `${mm.toString().padStart(2,'0')}:` +
           `${ss.toString().padStart(2,'0')}`;
}

function formatDateWithOverflow(hex){

    let dd = parseInt(hex.slice(0,2),16);
    let mm = parseInt(hex.slice(2,4),16);
    let yy = parseInt(hex.slice(4,6),16);

    if(dateOverflow){
        dd += 1;
    }

    return `${dd.toString().padStart(2,'0')}/` +
           `${mm.toString().padStart(2,'0')}/20${yy}`;
}

function calcCRC16(bytes){
    let crc = 0xFFFF;
    for (let b of bytes){
        crc ^= parseInt(b,16);
        for (let i=0;i<8;i++){
            if (crc & 1) crc = (crc >> 1) ^ 0xA001;
            else crc >>= 1;
        }
    }
    return crc.toString(16).padStart(4,'0');
}

function parse(){

    const hexRaw = document.getElementById("hexInput").value.replace(/\s/g,'');
    const bytes = hexRaw.match(/.{1,2}/g);

    if(!bytes){
        alert("Invalid HEX input");
        return;
    }

    const table = document.getElementById("result");

    table.innerHTML = `
    <tr>
    <th>Field</th>
    <th>Hex</th>
    <th>Value</th>
    </tr>`;

    function row(name, hex, val, cls=""){
        let r = table.insertRow();
        r.insertCell(0).innerText = name;
        r.insertCell(1).innerText = "0x"+hex;
        let v = r.insertCell(2);
        v.innerText = val;
        if(cls) v.className = cls;
    }

    // HEADER
    row("Frame head", bytes[0], "Start Frame");
    row("Length", bytes[1], hexToInt(bytes[1]));
    row("Address", bytes.slice(2,6).join(""),
        hexToInt(bytes.slice(2,6).join("")));

    row("Dimming port", bytes[6], "Fixed");
    row("Dimming function", bytes[7], "Fixed");
    row("Dimming value", bytes[8], hexToInt(bytes[8])+" %");

    row("Turn port", bytes[9], "Fixed");
    row("Turn function", bytes[10], "Fixed");
    row("Turn status", bytes[11],
        bytes[11]=="00"?"ON":"OFF");

    row("Collection port", bytes[12], "Fixed");
    row("Collection function", bytes[13], "Fixed");
    row("Effective length", bytes[14], "Fixed");

    // ELECTRICAL
    row("Voltage", bytes.slice(15,17).join(""),
        (hexToInt(bytes.slice(15,17).join(""))/100)+" V");

    row("Current", bytes.slice(17,19).join(""),
        (hexToInt(bytes.slice(17,19).join(""))/1000)+" A");

    row("Active Power", bytes.slice(19,21).join(""),
        (hexToInt(bytes.slice(19,21).join(""))/10)+" W");

    row("Reactive Power", bytes.slice(21,23).join(""),
        (hexToInt(bytes.slice(21,23).join(""))/10)+" W");

    row("Frequency", bytes.slice(23,25).join(""),
        (hexToInt(bytes.slice(23,25).join(""))/100)+" Hz");

    row("Active Energy", bytes.slice(25,27).join(""),
        (hexToInt(bytes.slice(25,27).join(""))/100)+" kWh");

    let tempHex = bytes.slice(27,29).join("");
    let tempRaw = hexToInt(tempHex);
    let tempValue = (tempRaw > 100000)
        ? (tempRaw - 100000)/100
        : tempRaw/100;

    row("Temperature", tempHex, tempValue+" °C");

    // TIME & DATE (UTC+7)
    let timeHex = bytes.slice(29,32).join("");
    row("Time (UTC+7)", timeHex, formatTimeUTC7(timeHex));

    let dateHex = bytes.slice(32,35).join("");
    row("Date", dateHex, formatDateWithOverflow(dateHex));

    // NETWORK SECTION
    let idx = 35;

    function get4(name, signed=false){
        if(idx + 4 > bytes.length-8) return;
        let hex = bytes.slice(idx,idx+4).join("");
        let val = signed ? hexToSigned32(hex) : hexToInt(hex);
        row(name, hex, val);
        idx += 4;
    }

    get4("Signal Power");
    get4("Total Power");
    get4("Tx Power");
    get4("Rx Power");
    get4("Tx Time");
    get4("Rx Time");
    get4("Cell ID");
    get4("ECL");
    get4("SNR", true);
    get4("Earfcn");
    get4("PCI");
    get4("RSRQ", true);

    // DEVICE WORKING (FROM BACK)
    let workingHex =
        bytes[bytes.length - 8] +
        bytes[bytes.length - 7] +
        bytes[bytes.length - 6] +
        bytes[bytes.length - 5];

    row("Device Working Times",
        workingHex,
        hexToInt(workingHex)+" minutes");

    // RESTART
    let restartHex =
        bytes[bytes.length - 4] +
        bytes[bytes.length - 3];

    row("Restart Times",
        restartHex,
        hexToInt(restartHex)+" times");

    // CRC
    let crcFrame =
        bytes[bytes.length - 2] +
        bytes[bytes.length - 1];

    let crcCalc = calcCRC16(bytes.slice(0,bytes.length-2));

    row("CRC16 (Frame)", crcFrame,
        "Calculated: 0x"+crcCalc,
        crcFrame.toLowerCase()==crcCalc.toLowerCase()?"ok":"err");
}

</script>
</body>
</html>